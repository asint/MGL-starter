!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.MGL=e():t.MGL=e()}(window,(function(){return function(t){var e={};function i(r){if(e[r])return e[r].exports;var n=e[r]={i:r,l:!1,exports:{}};return t[r].call(n.exports,n,n.exports,i),n.l=!0,n.exports}return i.m=t,i.c=e,i.d=function(t,e,r){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:r})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(i.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)i.d(r,n,function(e){return t[e]}.bind(null,n));return r},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=10)}([function(t,e,i){"use strict";function r(t,e,i){this.x=t||0,this.y=e||0,this.z=i||0}i.d(e,"a",(function(){return r})),Object.assign(r.prototype,{_er:function(t){console.log("mGL-Err: "+(t||"Type"))},toString:function(){return"["+this.x.toPrecision(6)+","+this.y.toPrecision(6)+","+this.z.toPrecision(6)+"]"},set:function(t,e,i){return this.x=t,this.y=e,this.z=i,this},equals:function(t){return t&&this.x===t.x&&this.y===t.y&&this.z===t.z},add:function(t){return"number"==typeof t?(this.x+=t,this.y+=t,this.z+=t):"object"==typeof t?(t.hasOwnProperty("x")&&(this.x+=t.x),t.hasOwnProperty("y")&&(this.x+=t.x),t.hasOwnProperty("z")&&(this.x+=t.x)):this._er(),this},addScalar:function(t){return this.x+=t,this.y+=t,this.z+=t,this},addVector:function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this},Add:function(t,e){return"number"==typeof e?new r(t.x+e,t.y+e,t.z+e):new r(t.x+e.x,t.y+e.y,t.z+e.z)},sub:function(t){return"number"==typeof t?(this.x-=t,this.y-=t,this.z-=t):"object"==typeof t?(t.hasOwnProperty("x")&&(this.x-=t.x),t.hasOwnProperty("y")&&(this.x-=t.x),t.hasOwnProperty("z")&&(this.x-=t.x)):this._er(),this},subVector:function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this},subScalar:function(t){return this.x-=t,this.y-=t,this.z-=t,this},Sub:function(t,e){return"number"==typeof e?new r(t.x-e,t.y-e,t.z-e):new r(t.x-e.x,t.y-e.y,t.z-e.z)},clone:function(){return new r(this.x,this.y,this.z)},copy:function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this},dot:function(t){return this.x*t.x+this.y*t.y+this.z*t.z},Dot:function(t,e){return t.x*e.x+t.y*e.y+t.z*e.z},cross:function(t){return new r(this.y*t.z-this.z*t.y,this.z*t.x-this.x*t.z,this.x*t.y-this.y*t.x)},Cross:function(t,e){return new r(t.y*e.z-t.z*e.y,t.z*e.x-t.x*e.z,t.x*e.y-t.y*e.x)},toArray:function(t,e){var i=e||0;return t[i]=this.x,t[i+1]=this.y,t[i+2]=this.z,this},fromArray:function(t,e){var i=e||0;return this.x=t[i],this.y=t[i+1],this.z=t[i+2],this},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},length2:function(){return this.x*this.x+this.y*this.y+this.z*this.z},lerp:function(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this.z+=(t.z-this.z)*e,this},Lerp:function(t,e,i){return new r(t.x+=(e.x-t.x)*i,t.y+=(e.y-t.y)*i,t.z+=(e.z-t.z)*i)},nlerp:function(t,e){return this.lerp(t,e).divideScalar(this.length())},Nlerp:function(t,e,i){return r.Lerp(t,e,i).divideScalar(this.length())},minTo:function(t){return null==t?t=this.clone():(this.x>t.x&&(t.x=this.x),this.y>t.y&&(t.y=this.y),this.z>t.z&&(t.z=this.z)),t},maxTo:function(t){return null==t?t=this.clone():(this.x<t.x&&(t.x=this.x),this.y<t.y&&(t.y=this.y),this.z<t.z&&(t.z=this.z)),t},multiply:function(t){return"number"==typeof t?(this.x*=t,this.y*=t,this.z*=t):"object"==typeof t?(t.hasOwnProperty("x")&&(this.x*=t.x),t.hasOwnProperty("y")&&(this.y*=t.x),t.hasOwnProperty("z")&&(this.y*=t.x)):this._er(),this},multiplyScalar:function(t){return this.x*=t,this.y*=t,this.z*=t,this},multiplyVector:function(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this},divide:function(t){return"number"==typeof t?this.divideScalar(t):"object"==typeof t?this.divideVector(t):(this._er(),this)},divideScalar:function(t){return t&&this.multiplyScalar(1/t),this},divideVector:function(t){return t.x&&(this.x*=1/t.x),t.y&&(this.y*=1/t.y),t.z&&(this.z*=1/t.z),this},negate:function(){return this.x=-x,this.y=-y,this.z=-z,this},normalize:function(){return this.divideScalar(this.length())},rotate:function(t){var e=this.x,i=this.y,r=this.z,n=t.x,s=t.y,o=t.z,a=t.w,h=a*e+s*r-o*i,u=a*i+o*e-n*r,l=a*r+n*i-s*e,c=-n*e-s*i-o*r;return this.x=h*a+c*-n+u*-o-l*-s,this.y=u*a+c*-s+l*-n-h*-o,this.z=l*a+c*-o+h*-s-u*-n,this},transform:function(t){var e=this.x,i=this.y,r=this.z,n=t[3]*e+t[7]*i+t[11]*r+t[15];return n=n||1,this.x=(t[0]*e+t[4]*i+t[8]*r+t[12])/n,this.y=(t[1]*e+t[5]*i+t[9]*r+t[13])/n,this.z=(t[2]*e+t[6]*i+t[10]*r+t[14])/n,this},isZero:function(){return!(this.x>.001||this.y>.001||this.z>.001)}}),console.log("Vector Init")},function(t,e,i){"use strict";i.d(e,"a",(function(){return r}));var r={create:function(){var t=new Float32Array(16);return t[0]=1,t[5]=1,t[10]=1,t[15]=1,t},clone:function(t){var e=new Float32Array(16);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},copy:function(t,e){for(var i=0;i<16;i++)t[i]=e[i];return t},move:function(t,e){return t[12]+=e.x,t[13]+=e.y,t[14]+=e.z,t},multiply:function(t,e,i){var r=e[0],n=e[1],s=e[2],o=e[3],a=e[4],h=e[5],u=e[6],l=e[7],c=e[8],f=e[9],d=e[10],m=e[11],_=e[12],p=e[13],v=e[14],g=e[15],b=i[0],x=i[1],T=i[2],E=i[3];return t[0]=b*r+x*a+T*c+E*_,t[1]=b*n+x*h+T*f+E*p,t[2]=b*s+x*u+T*d+E*v,t[3]=b*o+x*l+T*m+E*g,b=i[4],x=i[5],T=i[6],E=i[7],t[4]=b*r+x*a+T*c+E*_,t[5]=b*n+x*h+T*f+E*p,t[6]=b*s+x*u+T*d+E*v,t[7]=b*o+x*l+T*m+E*g,b=i[8],x=i[9],T=i[10],E=i[11],t[8]=b*r+x*a+T*c+E*_,t[9]=b*n+x*h+T*f+E*p,t[10]=b*s+x*u+T*d+E*v,t[11]=b*o+x*l+T*m+E*g,b=i[12],x=i[13],T=i[14],E=i[15],t[12]=b*r+x*a+T*c+E*_,t[13]=b*n+x*h+T*f+E*p,t[14]=b*s+x*u+T*d+E*v,t[15]=b*o+x*l+T*m+E*g,t},compose:function(t,e,i,r){var n=i.x+i.x,s=i.y+i.y,o=i.z+i.z,a=i.x*n,h=i.x*s,u=i.x*o,l=i.y*s,c=i.y*o,f=i.z*o,d=i.w*n,m=i.w*s,_=i.w*o;return t[0]=(1-(l+f))*r.x,t[1]=(h+_)*r.x,t[2]=(u-m)*r.x,t[3]=0,t[4]=(h-_)*r.y,t[5]=(1-(a+f))*r.y,t[6]=(c+d)*r.y,t[7]=0,t[8]=(u+m)*r.z,t[9]=(c-d)*r.z,t[10]=(1-(a+l))*r.z,t[11]=0,t[12]=e.x,t[13]=e.y,t[14]=e.z,t[15]=1,t},copyPos:function(t,e){t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=1},perspective:function(t,e,i,r,n){var s=1/Math.tan(e/2),o=1/(r-n);return t[0]=s/i,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=s,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=(n+r)*o,t[11]=-1,t[12]=0,t[13]=0,t[14]=2*n*r*o,t[15]=0,t},lookAt:function(t,e,i,r,n){var s=n||1,o=e.Sub(e,i).normalize(),a=e.Cross(r,o).normalize(),h=e.Cross(o,a).normalize();return t[0]=a.x*s,t[1]=a.y*s,t[2]=a.z*s,t[3]=0,t[4]=h.x*s,t[5]=h.y*s,t[6]=h.z*s,t[7]=0,t[8]=o.x*s,t[9]=o.y*s,t[10]=o.z*s,t[11]=0,t[12]=e.x,t[13]=e.y,t[14]=e.z,t[15]=1,t},getScale:function(t){var e=Math.hypot(t[0],t[1],t[2]),i=Math.hypot(t[4],t[5],t[6]),r=Math.hypot(t[8],t[9],t[10]);return Math.max(e,i,r)},invert:function(t,e){var i=e[0],r=e[1],n=e[2],s=e[3],o=e[4],a=e[5],h=e[6],u=e[7],l=e[8],c=e[9],f=e[10],d=e[11],m=e[12],_=e[13],p=e[14],v=e[15],g=f*v-p*d,b=c*v-_*d,x=c*p-_*f,T=l*v-m*d,E=l*p-f*m,w=l*_-m*c,y=+(a*g-h*b+u*x),A=-(o*g-h*T+u*E),M=+(o*b-a*T+u*w),R=-(o*x-a*E+h*w),P=i*y+r*A+n*M+s*R;if(0===P)return t;var O=h*v-p*u,U=a*v-_*u,L=a*p-_*h,I=o*v-m*u,S=o*p-m*h,D=o*_-m*a,C=h*d-f*u,z=a*d-c*u,B=a*f-c*h,F=o*d-l*u,N=o*f-l*h,V=o*c-l*a,X=-(r*g-n*b+s*x),G=+(i*g-n*T+s*E),k=-(i*b-r*T+s*w),j=+(i*x-r*E+n*w),W=+(r*O-n*U+s*L),q=-(i*O-n*I+s*S),Y=+(i*U-r*I+s*D),K=-(i*L-r*S+n*D),H=-(r*C-n*z+s*B),J=+(i*C-n*F+s*N),Q=-(i*z-r*F+s*V),Z=+(i*B-r*N+n*V),$=1/P;return t[0]=y*$,t[1]=X*$,t[2]=W*$,t[3]=H*$,t[4]=A*$,t[5]=G*$,t[6]=q*$,t[7]=J*$,t[8]=M*$,t[9]=k*$,t[10]=Y*$,t[11]=Q*$,t[12]=R*$,t[13]=j*$,t[14]=K*$,t[15]=Z*$,t}}},function(t,e,i){"use strict";i.d(e,"a",(function(){return n}));var r=i(0);function n(t,e,i,r){this.x=t||0,this.y=e||0,this.z=i||0,this.w=void 0!==r?r:1}var s=new r.a,o=(new r.a,new n);Object.assign(n.prototype,{toString:function(){return"["+this.x.toPrecision(4)+","+this.y.toPrecision(4)+","+this.z.toPrecision(4)+","+this.w.toPrecision(4)+"]"},clone:function(){return new n(this.x,this.y,this.z,this.w)},equals:function(t){return n.Dot(this,t)>=0},set:function(t,e,i,r){return this.x=t,this.y=e,this.z=i,this.w=r,this},setAxisAngle:function(t,e){var i=Math.sin(e/2);return this.x=t.x*i,this.y=t.y*i,this.z=t.z*i,this.w=Math.cos(e/2),this},copy:function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this},toArray:function(t,e){var i=e||0;return t[i]=this.x,t[i+1]=this.y,t[i+2]=this.z,t[i+3]=this.w,this},fromArray:function(t,e){var i=e||0;return this.x=t[i],this.y=t[i+1],this.z=t[i+2],this.w=t[i+3],this},multiply:function(t){var e=this.x*t.w+this.y*t.z-this.z*t.y+this.w*t.x,i=-this.x*t.z+this.y*t.w+this.z*t.x+this.w*t.y,r=this.x*t.y-this.y*t.x+this.z*t.w+this.w*t.z,n=-this.x*t.x-this.y*t.y-this.z*t.z+this.w*t.w;return this.set(e,i,r,n),this},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},normalize:function(){var t=this.length();if(0===t)return this;var e=1/t;return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this},inverse:function(){return this.x*=-1,this.y*=-1,this.z*=-1,this.normalize(),this},Dot:function(t,e){return t.x*e.x+t.y*e.y+t.z*e.z+t.w*e.w},Forward:function(){return new r.a(2*(this.x*this.z+this.w*this.y),2*(this.y*this.z-this.w*this.x),1-2*(this.x*this.x+this.y*this.y))},toEuler:function(){var t=new r.a,e=this.x*this.x,i=this.y*this.y,n=this.z*this.z,s=this.w*this.w,o=this.y*this.z-this.x*this.w;return o<-.49999999?(t.x=Math.PI/2,t.y=2*Math.atan2(this.y,this.w),t.z=0):o>.49999999?(t.x=-Math.PI/2,t.y=2*Math.atan2(this.y,this.w),t.z=0):(t.x=Math.asin(-2*(this.z*this.y-this.x*this.w)),t.y=Math.atan2(2*(this.z*this.x+this.y*this.w),n-e-i+s),t.z=Math.atan2(2*(this.x*this.y+this.z*this.w),-n-e+i+s)),t},fromEuler:function(t){s.copy(t).multiplyScalar(.5);var e=Math.sin(s.x),i=Math.cos(s.x),r=Math.sin(s.y),n=Math.cos(s.y),o=Math.sin(s.z),a=Math.cos(s.z);return this.x=n*e*a+r*i*o,this.y=r*i*a-n*e*o,this.z=n*i*o-r*e*a,this.w=n*i*a+r*e*o,this},fromDevice:function(t,e,i){var r=Math.sin(e/2),n=Math.cos(e/2),s=Math.sin(t/2),o=Math.cos(t/2),a=Math.sin(-i/2),h=Math.cos(-i/2);return this.x=o*r*h+s*n*a,this.y=s*n*h-o*r*a,this.z=o*n*a-s*r*h,this.w=o*n*h+s*r*a,this},rotateX:function(t){var e=.5*t,i=Math.sin(e),r=Math.cos(e);return o.x=this.x*r+this.w*i,o.y=this.y*r+this.z*i,o.z=this.z*r-this.y*i,o.w=this.w*r-this.x*i,this.copy(o),this},rotateY:function(t){var e=.5*t,i=Math.sin(e),r=Math.cos(e);return o.x=this.x*r-this.z*i,o.y=this.y*r+this.w*i,o.z=this.z*r+this.x*i,o.w=this.w*r-this.y*i,this.copy(o),this},rotateZ:function(t){var e=.5*t,i=Math.sin(e),r=Math.cos(e);return o.x=this.x*r+this.y*i,o.y=this.y*r-this.x*i,o.z=this.z*r+this.w*i,o.w=this.w*r-this.z*i,this.copy(o),this},Slerp:function(t,e,i){var r,s,o=!1,a=t.x*e.x+t.y*e.y+t.z*e.z+t.w*e.w;if(a<0&&(a=-a,o=!0),a>.99999999)r=1-i,s=o?-i:i;else{var h=Math.acos(a),u=1/Math.sin(h);r=Math.sin((1-i)*h)*u,s=o?-Math.sin(i*h)*u:Math.sin(i*h)*u}return new n(r*t.x+s*e.x,r*t.y+s*e.y,r*t.z+s*e.z,r*t.w+s*e.w)},lookTo:function(t,e){t.normalize();var i=e.clone().cross(t).normalize(),r=t.clone().cross(i),n=i.x+r.y+t.z;if(n>0){var s=.5/Math.sqrt(n+1);this.w=.25/s,this.x=(r.z-t.y)*s,this.y=(t.x-i.z)*s,this.z=(i.y-r.x)*s}else if(i.x>r.y&&i.x>t.z){s=2*Math.sqrt(1+i.x-r.y-t.z);this.w=(r.z-t.y)/s,this.x=.25*s,this.y=(r.x+i.y)/s,this.z=(t.x+i.z)/s}else if(r.y>t.z){s=2*Math.sqrt(1+r.y-i.x-t.z);this.w=(t.x-i.z)/s,this.x=(r.x+i.y)/s,this.y=.25*s,this.z=(t.y+r.z)/s}else{s=2*Math.sqrt(1+t.z-i.x-r.y);this.w=(i.y-r.x)/s,this.x=(t.x+i.z)/s,this.y=(t.y+r.z)/s,this.z=.25*s}return this}})},function(t,e,i){"use strict";i.d(e,"a",(function(){return h}));var r=i(0),n=i(2),s=i(1),o=new r.a(0,1,0),a=new n.a;function h(t,e,i,o,a,h,u){if(this.root=t,this._p=e||"base",this.position=o||new r.a,this.quaternion=a||new n.a,this.qOffsets=[],this.scale=h||new r.a(1,1,1),this.name=i||"",this.worldPos=this.position.clone(),this.lookAt=null,this.enabled=!0,this.childs=[],this.changed=!0,this.matrix=s.a.compose(s.a.create(),this.position,this.quaternion,this.scale),this.world=s.a.create(),this.onUpdate=null,this.onCollide=null,"root"===e)this.prepMatrix(s.a.create());else{var l=this.root.get(this._p).world;this.prepMatrix(l)}}Object.defineProperties(h.prototype,{parent:{get:function(){return this._p},set:function(t){if(this._p){var e=this.root,i=e.get(this._p),r=i.childs.indexOf(this.name);r>-1&&i.childs.splice(r,1)}this._p=t,e.get(t).childs.push(this.name)}}}),Object.assign(h.prototype,{clone:function(t,e,i,r,n,s){return this.root.AddTransform(t,e,i,r,n,s)},move:function(t){return this.position.addVector(t),this.changed=!0,this},rotateX:function(t){return this.quaternion.rotateX(t),this.changed=!0,this},rotateY:function(t){return this.quaternion.rotateY(t),this.changed=!0,this},rotateZ:function(t){return this.quaternion.rotateZ(t),this.changed=!0,this},prepMatrix:function(t,e){var i=e||!1;if(this.enabled){if(this.changed){for(a.copy(this.quaternion);this.qOffsets.length;)a.multiply(this.qOffsets.pop());s.a.compose(this.matrix,this.position,a,this.scale),this.changed=!1,i=!0}if((i||this.lookAt)&&(s.a.multiply(this.world,t,this.matrix),this.worldPos.set(0,0,0).transform(this.world),this.lookAt)){var r=this.root.get(this.lookAt);r&&(s.a.lookAt(this.world,this.worldPos,r.worldPos,o),i=!0)}for(var n=0;n<this.childs.length;n++){this.root.get(this.childs[n]).prepMatrix(this.world,i)}this.afterMatrix&&this.afterMatrix(t,i)}}})},function(t,e,i){"use strict";function r(t,e,i,r,n){this.root=t,this.name=e,this.texture=null,this.img=i||null,this.url=r||"",this.init(n)}function n(t){return 0==(t&t-1)}i.d(e,"a",(function(){return r})),r.prototype.init=function(t){var e=this.root.gl;this.texture=e.createTexture(),e.bindTexture(e.TEXTURE_2D,this.texture),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST);const i=e.RGBA,r=e.RGBA,s=e.UNSIGNED_BYTE;if(null===this.img){const h=2,u=2,l=0,c=new Uint8Array([255,224,255,255,240,240,255,255,240,240,255,255,255,224,255,255]);if(t&&t.length)for(var o=0;o<4;o++)c[4*o]=t[0],c[4*o+1]=t[1],c[4*o+2]=t[2];if(e.texImage2D(e.TEXTURE_2D,0,i,h,u,l,r,s,c),this.url){this.img=new Image;var a=this;this.img.onload=function(){e.bindTexture(e.TEXTURE_2D,a.texture),e.texImage2D(e.TEXTURE_2D,0,i,r,s,a.img),n(a.img.width)&&n(a.img.height)?(e.generateMipmap(e.TEXTURE_2D),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR)):(e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR))},this.img.src=this.url}}else e.texImage2D(e.TEXTURE_2D,0,i,r,s,this.img)}},function(t,e,i){"use strict";function r(t,e,i,r){this.mgl=t,this.program=null,this.attributes={},this.uniforms={},this.pipeline=null,this.program=function(t,e,i,r){var a="#define _SMAP\n";if(Array.isArray(i)){i.sort();for(var h=0;h<i.length;h++)a+="#define "+i[h]+"\n"}var u=s,l=o;r&&(r.vertex&&(u=r.vertex),r.fragment&&(l=r.fragment));const c=n(t,t.VERTEX_SHADER,a+u),f=n(t,t.FRAGMENT_SHADER,a+l),d=t.createProgram();if(t.attachShader(d,c),t.attachShader(d,f),t.linkProgram(d),!t.getProgramParameter(d,t.LINK_STATUS))return alert("Unable to init shader program: "+t.getProgramInfoLog(d)),null;return d}(this.mgl.gl,0,i,r),function(t,e){e.attributes.POSITION=t.getAttribLocation(e.program,"aPosition"),e.attributes.NORMAL=t.getAttribLocation(e.program,"aNormal"),e.attributes.TEXCOORD_0=t.getAttribLocation(e.program,"aUv"),e.uniforms.pview=t.getUniformLocation(e.program,"mPV"),e.uniforms.pviewi=t.getUniformLocation(e.program,"mPVi"),e.uniforms.model=t.getUniformLocation(e.program,"mM"),e.uniforms.shadow=t.getUniformLocation(e.program,"mShadow"),e.uniforms.shadowMap=t.getUniformLocation(e.program,"shadowMap"),e.uniforms.cam=t.getUniformLocation(e.program,"pCam"),e.uniforms.lights0position=t.getUniformLocation(e.program,"lights[0].position"),e.uniforms.lights0color=t.getUniformLocation(e.program,"lights[0].color"),e.uniforms.lights0ambient=t.getUniformLocation(e.program,"lights[0].ambient"),e.uniforms.matBase=t.getUniformLocation(e.program,"ml.base"),e.uniforms.matEmiss=t.getUniformLocation(e.program,"ml.emiss"),e.uniforms.matRough=t.getUniformLocation(e.program,"ml.rough"),e.uniforms.matMetal=t.getUniformLocation(e.program,"ml.metal"),e.uniforms.matBaseTex=t.getUniformLocation(e.program,"ml.baseTexture"),e.uniforms.matNormTex=t.getUniformLocation(e.program,"ml.normTexture"),e.uniforms.matRomeTex=t.getUniformLocation(e.program,"ml.romeTexture"),e.uniforms.matEmisTex=t.getUniformLocation(e.program,"ml.emisTexture"),e.uniforms.envTex=t.getUniformLocation(e.program,"envTexture"),e.uniforms.blur=t.getUniformLocation(e.program,"blur"),e.uniforms.displayTex=t.getUniformLocation(e.program,"displayTex"),e.uniforms.alpha=t.getUniformLocation(e.program,"alpha"),e.uniforms.color=t.getUniformLocation(e.program,"color")}(this.mgl.gl,this)}function n(t,e,i){const r=t.createShader(e);return t.shaderSource(r,i),t.compileShader(r),t.getShaderParameter(r,t.COMPILE_STATUS)?r:(alert("Error compiling the shader: "+t.getShaderInfoLog(r)),t.deleteShader(r),null)}i.d(e,"a",(function(){return r})),Object.assign(r.prototype,{reload:function(){}});const s="\nprecision highp float;\n\nattribute vec4 aPosition;\nattribute vec3 aNormal;\nuniform mat4 mPV;\nuniform mat4 mM;\nvarying vec3 vPosition;\nvarying vec3 vNormal;\n\n#ifdef _UV\nattribute vec2 aUv;\nvarying vec2 vUv;\n#endif\n\n#ifdef _SMAP\nuniform mat4 mShadow;\nvarying vec4 vShadow;\n#endif\n\n#ifdef _SKIN\nattribute vec4 aJoint;\nattribute vec4 aWeight;\nuniform sampler2D jointTexture;\nuniform float numJoints;\n\n#define ROW0_U ((0.5 + 0.0) / 4.)\n#define ROW1_U ((0.5 + 1.0) / 4.)\n#define ROW2_U ((0.5 + 2.0) / 4.)\n#define ROW3_U ((0.5 + 3.0) / 4.)\n \nmat4 getBoneMatrix(float jointN) {\n  float v = (jointN + 0.5) / numJoints;\n  return mat4(\n    texture2D(jointTexture, vec2(ROW0_U, v)),\n    texture2D(jointTexture, vec2(ROW1_U, v)),\n    texture2D(jointTexture, vec2(ROW2_U, v)),\n    texture2D(jointTexture, vec2(ROW3_U, v)));\n}\n#endif\n\nvoid main(void) {\n  \n#ifdef _SKIN\n  mat4 mSkin = getBoneMatrix(a_JOINTS_0[0]) * a_WEIGHTS_0[0] +\n    getBoneMatrix(a_JOINTS_0[1]) * a_WEIGHTS_0[1] +\n    getBoneMatrix(a_JOINTS_0[2]) * a_WEIGHTS_0[2] +\n    getBoneMatrix(a_JOINTS_0[3]) * a_WEIGHTS_0[3];\n  mat4 mMS = mM * mSkin;  \n#else\n  mat4 model = mM;\n#endif\n  gl_Position = mPV * model * aPosition;\n  vPosition = vec3(model * aPosition);\n  vNormal = vec3(model * vec4(aNormal, 0.0));\n#ifdef _UV\n  vUv = aUv;\n#endif\n#ifdef _SMAP\n  vShadow = mShadow * model * aPosition;\n#endif\n}\n",o="\nprecision highp float;\nstruct Light {\n    vec3 position;\n    vec3 color;\n    float ambient;\n};\nstruct Material {\n    vec3 base;\n    vec3 emiss;\n    float rough;\n    float metal;\n#ifdef _UV\n    sampler2D baseTexture;\n    sampler2D normTexture;\n    sampler2D romeTexture; \n    sampler2D emisTexture;\n#endif\n};\n#define _L 1\nuniform Light lights[_L];\nuniform Material ml;\nuniform samplerCube envTexture;\nuniform vec3 pCam;\nvarying vec3 vPosition;\nvarying vec3 vNormal;\n\n#ifdef _SMAP\nuniform sampler2D shadowMap;\nvarying vec4 vShadow;\n#endif\n\n#ifdef _UV\n  varying vec2 vUv;\n  vec3 applyNormalMap(vec3 geomnor, vec3 normap) {\n      normap = normap * 2.0 - 1.0;\n      vec3 up = normalize(vec3(0.01, 1, 0.01));\n      vec3 surftan = normalize(cross(geomnor, up));\n      vec3 surfbinor = cross(geomnor, surftan);\n      return normap.y * surftan * 1. + normap.x * surfbinor * 1. + normap.z * geomnor;\n  }\n  vec3 getNormal() {\n      vec3 n = normalize(applyNormalMap( vNormal, texture2D(ml.normTexture, vUv).rgb));\n      return n;\n  }\n#else\n  vec3 getNormal() {\n      return normalize(vNormal);\n  }\n#endif\n\nvec3 calcLight(Light l, vec3 norm, vec3 refl, vec3 base, float rough) {\n    vec3 lDir = normalize(l.position-vPosition);\n    float ndl = dot(norm, lDir);\n    float invShadow = 1.0;\n#ifdef _SMAP\n    float bias = max(0.02 * (1.0 - ndl), 0.006);\n    vec3 shCoords = vShadow.xyz / vShadow.w * 0.5 + 0.5;\n    shCoords.z = min(shCoords.z, 1.0) - bias;\n    float shadowDepth = texture2D(shadowMap, shCoords.xy).r;\n    if ( shCoords.z > shadowDepth ) invShadow -= 0.2;\n    shadowDepth = texture2D(shadowMap, shCoords.xy + vec2(.001,.001)).r;\n    if ( shCoords.z > shadowDepth ) invShadow -= 0.2;\n    shadowDepth = texture2D(shadowMap, shCoords.xy + vec2(.001,-.001)).r;\n    if ( shCoords.z > shadowDepth ) invShadow -= 0.2;\n    shadowDepth = texture2D(shadowMap, shCoords.xy + vec2(-.001,.001)).r;\n    if ( shCoords.z > shadowDepth ) invShadow -= 0.2;\n    shadowDepth = texture2D(shadowMap, shCoords.xy + vec2(-.001,-.001)).r;\n    if ( shCoords.z > shadowDepth ) invShadow -= 0.2;\n#endif\n    vec3 difCol = base * l.color * max(ndl, 0.) * (1.-l.ambient) * invShadow;\n    difCol += (ndl + 4.)*.2 * l.ambient * base * l.color;\n    float smooth = 1. - rough;\n    float spec = pow(max(dot(refl, lDir), 0.0), max(pow(2.,smooth*8.),4.))* smooth;\n    return min(difCol + (l.color * smooth * .5 * spec * invShadow) ,1.);\n}\n\nvec3 vnoise(vec3 v){\n    float r = tan(mod((v.x - v.y) * 5156.1, 3.1416)); \n    float r2 = r + tan(mod((v.y - v.z) * 4682.3, 3.1416));\n    float x = fract(r2*(v.y));\n    float y = fract(r2*(v.z));\n    float z = fract(r2*(v.x));\n    return vec3(x,y,z);\n}\n\n\nvoid main(void) {\n    vec3 norm = getNormal();\n    vec3 v = normalize(pCam - vPosition);\n#ifdef _UV\n    float rough = texture2D(ml.romeTexture, vUv).g * ml.rough;\n    float metal = texture2D(ml.romeTexture, vUv).b * ml.metal;\n    vec3 base = texture2D(ml.baseTexture, vUv).rgb * ml.base;\n    vec3 emis = texture2D(ml.emisTexture, vUv).rgb;\n#else\n    float rough = ml.rough;\n    float metal = ml.metal;\n    vec3 base = ml.base;\n    vec3 emis = ml.emiss;\n#endif\n    vec3 refl = -normalize(reflect(v, norm));\n    vec3 rCol = vec3(0.0, 0.0, 0.0);\n    if (metal > 0.1){\n      float mipCount = 5.0; // resolution of 256x256\n      float lod = min(rough * mipCount, 3.0);\n      vec3 vr = rough * vec3 (0.01, 0.01, 0.01);\n      vec3 refl2 = normalize(refl + vr);\n      vec3 refl3 = normalize(refl - vr);\n      vec3 rCol1 = textureCube(envTexture, refl, lod).rgb;\n      vec3 rCol2 = textureCube(envTexture, refl2, max(lod-1.0,0.0)).rgb;\n      vec3 rCol3 = textureCube(envTexture, refl3, max(lod-1.0,0.0)).rgb;\n      rCol = (rCol1 + rCol2 + rCol3) / 3.0 * metal * mix(base, vec3(.8,.8,.8), .5);\n    }\n    vec3 col = vec3(0.0, 0.0, 0.0);\n    for(int i = 0; i < _L; i++)\n        col += calcLight(lights[i], norm, refl, base, rough);\n    col = ((1.-metal) * col) + emis + rCol;\n    gl_FragColor = vec4(col, 1.);\n}\n"},function(t,e,i){"use strict";i.d(e,"a",(function(){return r}));var r=function(t,e){this.bufferView=e,this.componentType=t.componentType,this.count=t.count,this.min=t.min||null,this.max=t.max||null,this.type=t.type,this.byteOffset=void 0!==t.byteOffset?t.byteOffset:0,this.normalized=void 0!==t.normalized&&t.normalized,this.size=n[this.type],this.extensions=void 0!==t.extensions?t.extensions:null,this.extras=void 0!==t.extras?t.extras:null};r.prototype.prepAttrib=function(t,e){e.vertexAttribPointer(t,this.size,this.componentType,this.normalized,this.bufferView.stride,this.byteOffset),e.enableVertexAttribArray(t)};var n={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16}},function(t,e,i){"use strict";i.d(e,"a",(function(){return r}));var r=function(t,e,i,r){this.data,0===t&&e===i.len?this.data=i:this.data=i.slice(t,t+e),this.stride=r||0,this.buffer=null};r.prototype.prepBuffer=function(t,e){if(t.webGPU)this.buffer=t.device.createBuffer();else{var i=t.gl;this.buffer=i.createBuffer(),i.bindBuffer(e,this.buffer),i.bufferData(e,this.data,i.STATIC_DRAW),i.bindBuffer(e,null)}}},function(t,e,i){"use strict";i.d(e,"a",(function(){return h})),i.d(e,"b",(function(){return u}));var r=i(3),n=i(6),s=i(7),o=i(0),a=(i(1),i(9));function h(t,e,i,n,s,h,u,l){this.area=new a.a(n.clone()),r.a.call(this,t,e,i,n,s,h,u),this.primitives=[],this.bounds={min:new o.a,max:new o.a},this._maker={},this.instance=this.name,this.castShadows=l||!1,this.opacity=1,this.alpha=!1,this.worldBounds={min:new o.a,max:new o.a},console.log("Mesh: "+this.name+" Added @ "+this.position)}function u(t){this.root=t,this.bounds={min:null,max:null},this.material="default",this.attributes={},this.indices=null}h.prototype=Object.create(r.a.prototype),h.prototype.constructor=h,h.prototype.afterMatrix=function(t,e){this.area.radius>0&&(this.area.setWorld(this.world),this.castShadows&&this.root.addShadowArea(this.area)),this.root.renderer.addObj(this.instance,this,this.alpha)},h.prototype.clone=function(t,e,i,r,n,s,o){var a=this.root.AddMesh(t,e,i,r,n,s,o);return a.primitives=this.primitives,a.bounds=this.bounds,a.area=this.area,a._maker={type:"clone",func:this.name},a.instance=this.instance,a},u.prototype.getVao=function(){if(2===glVersion)gl.createVertexArray();else if(glVersion>1)gl.getExtension("OES_vertex_array_object").createVertexArrayOES()},u.prototype.prepare=function(t){for(var e in this.attributes)this.attributes[e].bufferView.prepBuffer(t,t.gl.ARRAY_BUFFER);this.indices.bufferView.prepBuffer(t,t.gl.ELEMENT_ARRAY_BUFFER)},u.prototype.addAttr=function(t,e,i){var r=i||"VEC3",o=new s.a(0,e.length,e);this.attributes[t]=new n.a({componentType:5126,type:r,count:e.length/3},o)},u.prototype.addIndices=function(t){var e=new s.a(0,t.length,t);this.indices=new n.a({componentType:5123,type:"SCALAR",count:t.length},e)},h.prototype.addData=function(t,e,i,r){var n=new u(this.root);return n.material=t,n.addAttr("POSITION",e),n.addIndices(i),r&&n.addAttr("NORMAL",r),this.primitives.push(n),this},h.prototype.prepare=function(){var t=this.root;if(this.primitives&&this.primitives.length){for(var e=0;e<this.primitives.length;e++)this.primitives[e].bounds.min&&this.primitives[e].bounds.max&&(this.primitives[e].bounds.min[0]<this.bounds.min.x&&(this.bounds.min.x=this.primitives[e].bounds.min[0]),this.primitives[e].bounds.max[0]>this.bounds.max.x&&(this.bounds.max.x=this.primitives[e].bounds.max[0]),this.primitives[e].bounds.min[1]<this.bounds.min.y&&(this.bounds.min.y=this.primitives[e].bounds.min[1]),this.primitives[e].bounds.max[1]>this.bounds.max.y&&(this.bounds.max.y=this.primitives[e].bounds.max[1]),this.primitives[e].bounds.min[2]<this.bounds.min.z&&(this.bounds.min.z=this.primitives[e].bounds.min[2]),this.primitives[e].bounds.max[2]>this.bounds.max.z&&(this.bounds.max.z=this.primitives[e].bounds.max[2])),this.primitives[e].prepare(t);this.area.addBounds(this.bounds)}}},function(t,e,i){"use strict";i.d(e,"a",(function(){return s}));var r=i(1),n=i(0);function s(t,e,i,r,s){this.tag=i||"",this.center=t||new n.a,this.radius=e||0,this.mass=r||0,this._vel=s||new n.a,this.worldPos=this.center.clone(),this.worldRadius=this.radius}s.prototype.setWorld=function(t){var e=r.a.getScale(t);return this.worldPos.copy(this.center).transform(t),this.worldRadius=this.radius*e,this},s.prototype.addBounds=function(t){var e=t.min.clone().addVector(t.max).multiplyScalar(.5),i=t.max.clone().subVector(e).length();return 0===this.radius?(this.center.copy(e),this.radius=i):this._sphereExt(e,i),this},s.prototype.addSphere=function(t){return 0===this.radius?(this.center.copy(t.center),this.radius=t.radius):this._sphereExt(t.center,t.radius),this},s.prototype.addWorldSphere=function(t){return 0===this.radius?(this.center.copy(t.worldPos),this.radius=t.worldRadius):this._sphereExt(t.worldPos,t.worldRadius),this},s.prototype._sphereExt=function(t,e){var i=t.clone().subVector(this.center);if(i.isZero())e>this.radius&&(this.radius=e);else{var r=.5*(e+i.length()-this.radius);r>0&&(this.center.addVector(i.normalize().multiplyScalar(r)),this.radius+=r)}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"Scene",(function(){return Scene})),__webpack_require__.d(__webpack_exports__,"goFull",(function(){return goFull})),__webpack_require__.d(__webpack_exports__,"goVR",(function(){return goVR})),__webpack_require__.d(__webpack_exports__,"MGLroot",(function(){return MGLroot}));var _Window_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(11),_Renderer_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(12),_Camera_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(13),_Transform_js__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(3),_Shader_js__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__(5),_Mesh_js__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__(8),_Material_js__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__(14),_Environment_js__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__(15),_Light_js__WEBPACK_IMPORTED_MODULE_8__=__webpack_require__(16),_Forge_js__WEBPACK_IMPORTED_MODULE_9__=__webpack_require__(17),_Loader_js__WEBPACK_IMPORTED_MODULE_10__=__webpack_require__(18),_Controller_js__WEBPACK_IMPORTED_MODULE_11__=__webpack_require__(19),_Index_js__WEBPACK_IMPORTED_MODULE_12__=__webpack_require__(20),_Quaternion_js__WEBPACK_IMPORTED_MODULE_13__=__webpack_require__(2),_Vector3_js__WEBPACK_IMPORTED_MODULE_14__=__webpack_require__(0),_Matrix_js__WEBPACK_IMPORTED_MODULE_15__=__webpack_require__(1),_Collider_js__WEBPACK_IMPORTED_MODULE_16__=__webpack_require__(9),_MGLc={},_MGLs=[],_MGLlf=0,MGLuseGPU=!1,wakeLock=null;function Scene(t,e,i,r){_MGLc[t]=this,i&&(this.debug=document.getElementById(i)),r&&(this.timing=document.getElementById(r)),this.canvas=document.getElementById(t),this.name=t,this.webGPU=!1,this.webXR=!1,this.glVersion=0,this.gl=null,this.renderer=null,this._index=new _Index_js__WEBPACK_IMPORTED_MODULE_12__.a(this),this._lastFrame=0,this._inputs=null,this._ctrls=[],this.time=0,this.windows=[],this.camera=null,this.environments=[],this.base=new _Transform_js__WEBPACK_IMPORTED_MODULE_3__.a(this,"root","base"),this.meshShadows=!1,this._shadowArea=new _Collider_js__WEBPACK_IMPORTED_MODULE_16__.a,this._times={pre:[],matrix:[],render:[]},this.avgTime={pre:0,matrix:0,render:0},this.adapter,this.device,this.glsl,this.swap,this.depth,this.init(e)}function requestWakeLock(){if("wakeLock"in navigator)try{navigator.wakeLock.request("screen").then((function(t){wakeLock=t}))}catch(t){console.error(`${t.name}, ${t.message}`)}}function requestFullscreen(t){"requestFullscreen"in t.canvas&&t.canvas.insertAdjacentHTML("beforebegin",'<div id="MGLfull" style="z-index: 100; margin-bottom: -40px; height: 30px; position: relative; padding-top:10px; padding-right:10px; text-align: right;"><button onclick="MGL.goFull(\''+t.name+'\')" style="background-color: #33333388; color: #eee; border: 0; border-radius: 3px;">&#x26F6;</button></div>')}function requestVR(t){t.canvas.insertAdjacentHTML("beforebegin",'<div id="MGLfull" style="z-index: 100; margin-bottom: -40px; height: 30px; position: relative; padding-top:10px; padding-left:10px; text-align: left;"><button onclick="MGL.goVR(\''+t.name+'\')" style="background-color: #33333388; color: #eee; border: 0; border-radius: 3px;">VR</button></div>')}function goFull(t){var e=_MGLc[t];document.fullscreenElement==e.canvas.parentNode?document.exitFullscreen():(e.canvas.parentNode.requestFullscreen(),console.log("->FULLSCREEN"))}function goVR(t){var e=_MGLc[t];if(1===e.windows.length)100===(i=e.windows[0]).width&&(i.left=50,i.width=50,i.resize(),e.get("_vrCamL")||e.AddCamera(null,"_vrCamL",null,null,null,!0,i._cam),e.AddWindow("_vrCamL",0,0,50,100));else if(2===e.windows.length){var i=e.windows[0],r=e.windows[1];"_vrCamL"===r._cam&&(i.left=0,i.width=100,i.resize(),r=null,e.windows.length=1)}}function _MGLdebug(t,e){if(t.debug&&(t.debug.innerHTML=t._index.treeView()),t.timing){var i="P:"+t.avgTime.pre+" M:"+t.avgTime.matrix+" R:"+t.avgTime.render;t._inputs&&(i+="<br/>Rotation:"+t._inputs.quaternion.toEuler()),t.timing.innerHTML=i}}function MGLroot(t){return _MGLc[t]}function preRender(t,e){var i=performance.now();if(t._inputs&&t._inputs.update(),t._ctrls&&t._ctrls.length)for(var r=0;r<t._ctrls.length;r++)t._ctrls[r].update();preChild(t,t.base);var n=performance.now();t.timeProfile("pre",n-i),t.base.prepMatrix(_Matrix_js__WEBPACK_IMPORTED_MODULE_15__.a.create());var s=performance.now();t.timeProfile("matrix",s-n)}function preChild(t,e){e.onUpdate&&e.onUpdate();for(var i=0;i<e.childs.length;i++){var r=t.get(e.childs[i]);r.enabled&&preChild(t,r)}}Scene.prototype.init=async function(t){const e=this.canvas;if(e){if(e.insertAdjacentHTML("beforebegin",'<div id="MGLlogo" style="z-index: 100; margin-bottom: -50px; height: 30px; position: relative; padding-top:20px; text-align: center;"><span style="padding: 3px 10px; height: 24px; text-align: center; background-color: #eeeeee88; border-radius: 5px; display: inline-block;"><span style="vertical-align: middle">Powered by:</span><img src="http://makegl.com/MGL.svg" height="24" style="vertical-align:middle;"/><span style="vertical-align: middle"> MakeGL</span></span></div>'),setTimeout((function(){document.getElementById("MGLlogo").style.display="none"}),3e3),navigator.gpu&&MGLuseGPU)try{this.adapter=await navigator.gpu.requestAdapter(),this.device=await this.adapter.requestDevice(),this.gl=e.getContext("gpupresent"),this.glsl=await glslang.default(),this.swap=this.gl.configureSwapChain({device:this.device,format:"rgba8unorm"}),this.depth=this.device.createTexture({size:{width:300,height:300,depth:1},format:"depth32float",usage:GPUTextureUsage.OUTPUT_ATTACHMENT}),this.webGPU=!0,this.debug&&(this.debug.innerHTML+="Using: WebGPU<br/>")}catch(t){this.webGPU=!1}if(this.webXR=navigator.xr,!this.webGPU){if(this.gl=e.getContext("webgl2"),null===this.gl){this.gl=e.getContext("webgl");var i=this.gl.getExtension("WEBGL_depth_texture"),r=this.gl.getExtension("OES_vertex_array_object");if(null===this.gl)return void console.log("No WebGPU or WebGL");this.glVersion=1,i&&(this.glVersion=1.1),r&&(this.glVersion=1.2),this.debug&&(this.debug.innerHTML+="Using: WebGL1<br/>")}else this.glVersion=2,this.debug&&(this.debug.innerHTML+="Using: WebGL2<br/>");this.renderer=new _Renderer_js__WEBPACK_IMPORTED_MODULE_1__.a(this);var n=this.gl;n.cullFace(n.BACK),n.frontFace(n.CCW),n.enable(n.DEPTH_TEST),n.enable(n.CULL_FACE),n.depthFunc(n.LEQUAL)}defaultMaterial(this),t?loadScene(this,t):(defaultEngine(this),this.resize()),_MGLs.push(this),this.loop()}else console.log("No canvas element found!")},Scene.prototype.timeProfile=function(t,e){this._times[t].push(e),this._times[t].length>20&&this._times[t].shift();for(var i=0,r=0;r<this._times[t].length;r++)i+=this._times[t][r];this.avgTime[t]=(i/this._times[t].length).toFixed(2)},Scene.prototype.loop=function(t){var e=(t*=.001)-this._lastFrame;this._lastFrame=t,this._shadowArea.radius=0,this.renderer.reset(),preRender(this,e),this.render().then(function(){_MGLdebug(this,e),requestAnimationFrame(this.loop.bind(this))}.bind(this))},window.addEventListener("resize",(function(){for(var t in _MGLc)_MGLc[t].resize()})),Scene.prototype.addShadowArea=function(t){this._shadowArea.addWorldSphere(t)};var debug=!0;function rPass(){}function defaultEngine(t){var e=t.AddCamera();t.AddWindow(e.name),t.AddLight()}function defaultMaterial(t){t.AddMaterial("default").setShader(t)}function loadScene(i,jsonUrl){fetch(jsonUrl,{method:"get",headers:{Accept:"text/plain, */*","Content-Type":"application/json"}}).then((function(t){return t.json()})).then((function(data){for(var o=0;o<data.scene.length;o++){var el=data.scene[o],pa,na,po,qu,sc,e,cam;if(na=el.name,pa=el.parent?el.parent:"base",el.position&&(po=(new _Vector3_js__WEBPACK_IMPORTED_MODULE_14__.a).fromArray(el.position)),el.quaternion&&(qu=(new _Quaternion_js__WEBPACK_IMPORTED_MODULE_13__.a).fromArray(el.quaternion)),el.scale&&(sc=(new _Vector3_js__WEBPACK_IMPORTED_MODULE_14__.a).fromArray(el.scale)),e=!el.enabled||el.enabled,"00"===el.type&&(el.wake&&requestWakeLock(),el.fullscreen&&requestFullscreen(i),el.vr&&requestVR(i)),"TM"===el.type){var t=i.AddTransform(pa,na,po,qu,sc,e);el.lookAt&&(t.lookAt=el.lookAt)}if("MH"===el.type){var added=[],cast=!1;if(el.castShadows&&(cast=!0),el.maker){if("Forge"===el.maker.type){var mesh=i.AddMesh(pa,na,po,qu,sc,e,cast),fn=el.maker.func,args=el.maker.params;args.unshift(mesh),_Forge_js__WEBPACK_IMPORTED_MODULE_9__.a[fn].apply(i,args),added.push(mesh),mesh.prepare()}"Loader"===el.maker.type&&Object(_Loader_js__WEBPACK_IMPORTED_MODULE_10__.a)(el.maker.func,i,pa,na,po,cast),"Clone"===el.maker.type&&i.get(el.maker.func).clone(pa,na,po,qu,sc,e,cast)}}if("CA"===el.type)el.stereo?cam=i.AddCamera(pa,na,null,null,null,!0,el.stereo):(cam=i.AddCamera(pa,na,po,qu),el.lookAt&&(cam.lookAt=el.lookAt));if("WN"===el.type){var dims=[0,0,100,100];el.dimensions&&Array.isArray(el.dimensions)&&(dims=el.dimensions),el.camera&&i.AddWindow(el.camera,dims[0],dims[1],dims[2],dims[3])}if("EV"===el.type){var maps=el.maps;i.AddEnvironment(na,null,maps)}if("LT"===el.type){var col=(new _Vector3_js__WEBPACK_IMPORTED_MODULE_14__.a).fromArray(el.color),am=el.ambient;i.AddLight(pa,na,po,qu,col,am)}if("MA"===el.type){var ba=(new _Vector3_js__WEBPACK_IMPORTED_MODULE_14__.a).fromArray(el.base),ro=el.roughness,me=el.metallic,em=(new _Vector3_js__WEBPACK_IMPORTED_MODULE_14__.a).fromArray(el.emissive),m=i.AddMaterial(na,ba,ro,me,em);m.setShader(i)}}for(var c=0;c<data.ctrls.length;c++){var con=_Controller_js__WEBPACK_IMPORTED_MODULE_11__.a[data.ctrls[c].type];if(con)var ctl=new con(i,data.ctrls[c].target);else console.log("CTL Not found: "+data.ctrls[c].type)}for(var f=0;f<data.functions.length;f++){var el=data.functions[f],tar=i.get(el.obj);if(tar){if(el.onUpdate){var cmd="tar.onUpdate = function(){"+el.onUpdate+"}";eval(cmd)}if(el.onTrigger){var cmd="tar.onEvent = function(mEvent){"+el.onEvent+"}";eval(cmd)}}}0===i.windows.length&&i.AddWindow(i.camera.name),0===i.environments.length&&i.AddEnvironment("DefaultEnv"),i.resize()}))}Scene.prototype.renderWindows=function(){return new Promise(function(t,e){var i=function(r,n){n>=r.windows.length?t():r.windows[n].render().then((function(){i(r,n+1)})).catch(e)};this.windows.length?i(this,0):t()}.bind(this))},Scene.prototype.render=function(){return new Promise(function(t,e){var i=performance.now();this.renderer.shadow().then(function(){this.renderWindows().then(function(){this.gl.flush();var e=performance.now();this.timeProfile("render",e-i),t()}.bind(this))}.bind(this))}.bind(this))},Object.assign(Scene.prototype,{get:function(t){return"root"===t?this:"base"===t?this.base:this._index.get(t)},AddTransform:function(t,e,i,r,n,s){var o=new _Transform_js__WEBPACK_IMPORTED_MODULE_3__.a(this,t,e,i,r,n,s);return o.name=this._index.regNew("TM",o,e),t?this.get(t).childs.push(o.name):this.base.childs.push(o.name),o},AddMesh:function(t,e,i,r,n,s,o){this.meshShadows&&(o=!0);var a=new _Mesh_js__WEBPACK_IMPORTED_MODULE_5__.a(this,t,e,i,r,n,s,o);return a.name=this._index.regNew("MH",a,e),t?this.get(t).childs.push(a.name):this.base.childs.push(a.name),a},AddLight:function(t,e,i,r,n,s){var o=new _Light_js__WEBPACK_IMPORTED_MODULE_8__.a(this,t,e,i,r,n,s,!0);return o.name=this._index.regNew("LT",o,e),t?this.get(t).childs.push(o.name):this.base.childs.push(o.name),o},AddEnvironment:function(t,e,i){var r=new _Environment_js__WEBPACK_IMPORTED_MODULE_7__.a(this,t,e,i);return this.environments.push(r),r},AddCamera:function(t,e,i,r,n,s,o){var a=new _Camera_js__WEBPACK_IMPORTED_MODULE_2__.a(this,t,e,i,r,n,s,o);return a.name=this._index.regNew("CA",a,e),a.parent?this.get(a.parent).childs.push(a.name):this.base.childs.push(a.name),null===this.camera&&(this.camera=a),a},AddWindow:function(t,e,i,r,n){var s=new _Window_js__WEBPACK_IMPORTED_MODULE_0__.a(this,t,e,i,r,n);return this.windows.push(s),s},AddMaterial:function(t,e,i,r,n,s,o,a,h){var u=new _Material_js__WEBPACK_IMPORTED_MODULE_6__.a(t,e,i,r,n,s,o,a,h);return u.name=this._index.regMat(t,u),u},AddShader:function(t,e){var i=t||"dF",r=e||[],n=i;if(Array.isArray(r)?(r.sort(),n+=r.join("")):r=[],n.replace(" ","_"),!this._index.getShade(n)){var s=new _Shader_js__WEBPACK_IMPORTED_MODULE_4__.a(this,i,r);this._index.regShade(n,s)}return n},resize:function(){this.gl.canvas.width=this.gl.canvas.clientWidth,this.gl.canvas.height=this.gl.canvas.clientHeight;for(var t=0;t<this.windows.length;t++)this.windows[t].resize()}})},function(t,e,i){"use strict";function r(t,e,i,r,n,s){this.root=t,this._cam=e||null,this.left=i||0,this.bottom=r||0,this.width=n||100,this.height=s||100,this._vs=[0,0,100,100],this._aspect=1,this.resize()}i.d(e,"a",(function(){return r})),Object.assign(r.prototype,{camera:function(t){this._cam=t},resize:function(){var t=this.root.gl.canvas;this._vs=[this.left/100*t.width,this.bottom/100*t.height,this.width/100*t.width,this.height/100*t.height],this._aspect=this._vs[2]/this._vs[3]},render:function(){return new Promise(function(t){if(this._cam){this.root.renderer.window(this._vs);var e=this.root.get(this._cam);e?e.render(this._aspect).then((function(){t()})):t()}else t()}.bind(this))}})},function(t,e,i){"use strict";i.d(e,"a",(function(){return u}));var r=i(5),n=i(0),s=i(1),o=i(4),a=s.a.create(),h=new n.a(0,1,0);function u(t){this.root=t,this.debug=!0,this.camTimes=[],this.renderAvg=0,this._solids={},this._alphas={},this._casters={},this._lightShader=null,this._shadowLight=null,this._shadowMatrix=s.a.create(),this._shadowCam={projection:s.a.create(),pView:s.a.create()},this._shadowSize=512,this._depthTex=null,this._depthFrame=null,this._imgTriBuffer=null,this._imgShader=null,this._spriteBuffer=null,this._spriteShader=null,this._areaImg=null,this.initImages(),this.initSprites(),this.initAreas()}u.prototype.reset=function(){this._casters={},this._solids={},this._alphas={}},u.prototype.addObj=function(t,e,i){var r=this._solids;i&&(r=this._alphas),r[t]?r[t].push(e):r[t]=[e],e.castShadows&&(this._casters[t]?this._casters[t].push(e):this._casters[t]=[e])},u.prototype.timeProfile=function(t){this.camTimes.push(t),this.camTimes.length>20&&this.camTimes.shift();for(var e=0,i=0;i<this.camTimes.length;i++)e+=this.camTimes[i];this.renderAvg=e/this.camTimes.length},u.prototype.window=function(t){var e=this.root.gl;return e.enable(e.SCISSOR_TEST),e.bindFramebuffer(e.FRAMEBUFFER,null),e.viewport(t[0],t[1],t[2],t[3]),e.scissor(t[0],t[1],t[2],t[3]),e.clearColor(.22,.26,.3,1),e.clearDepth(1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),e.disable(e.SCISSOR_TEST),e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),e.enable(e.DEPTH_TEST),e.depthFunc(e.LEQUAL),!0},u.prototype.camera=function(t){return new Promise(function(e,i){var r=performance.now();this.root.environments&&this.root.environments.length&&this.root.environments[0].render(t),this._rSolids(t);var n=performance.now();this.timeProfile(n-r),e()}.bind(this))},u.prototype._rSolids=function(t){var e=this.root.gl;for(var i in e.bindFramebuffer(e.FRAMEBUFFER,null),this._solids)this._rObjType(this._solids[i],t)},u.prototype._rObjType=function(t,e,i){var r=this.root.gl;if(t[0].primitives&&t[0].primitives.length)for(var n=0;n<t[0].primitives.length;n++){var s=t[0].primitives[n];if(i)o=i;else var o=this.root._index.getMat([s.material]).preDraw(this.root,this.debug);if(o){for(var a=this.root._index.getLights(),h=0;h<a.length;h++){var u=this.root.get(a[h]);r.uniform3f(o.uniforms["lights"+h+"position"],u.position.x,u.position.y,u.position.z),r.uniform3f(o.uniforms["lights"+h+"color"],u.color.x,u.color.y,u.color.z),r.uniform1f(o.uniforms["lights"+h+"ambient"],u.ambient)}r.enableVertexAttribArray(o.attributes.POSITION),r.bindBuffer(r.ARRAY_BUFFER,s.attributes.POSITION.bufferView.buffer),r.vertexAttribPointer(o.attributes.POSITION,3,r.FLOAT,!1,s.attributes.POSITION.bufferView.stride,s.attributes.POSITION.byteOffset),s.attributes.NORMAL&&o.attributes.NORMAL>-1&&(r.enableVertexAttribArray(o.attributes.NORMAL),r.bindBuffer(r.ARRAY_BUFFER,s.attributes.NORMAL.bufferView.buffer),r.vertexAttribPointer(o.attributes.NORMAL,3,r.FLOAT,!1,s.attributes.NORMAL.bufferView.stride,s.attributes.NORMAL.byteOffset)),s.attributes.TEXCOORD_0&&o.attributes.TEXCOORD_0>-1&&(r.enableVertexAttribArray(o.attributes.TEXCOORD_0),r.bindBuffer(r.ARRAY_BUFFER,s.attributes.TEXCOORD_0.bufferView.buffer),r.vertexAttribPointer(o.attributes.TEXCOORD_0,2,r.FLOAT,!1,s.attributes.TEXCOORD_0.bufferView.stride,s.attributes.TEXCOORD_0.byteOffset)),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,s.indices.bufferView.buffer),r.uniformMatrix4fv(o.uniforms.pview,!1,e.pView),null!=o.uniforms.cam&&r.uniform3f(o.uniforms.cam,e.worldPos.x,e.worldPos.y,e.worldPos.z),null!=o.uniforms.shadow&&r.uniformMatrix4fv(o.uniforms.shadow,!1,this._shadowCam.pView),null!=o.uniforms.shadowMap&&(r.activeTexture(r.TEXTURE4),r.bindTexture(r.TEXTURE_2D,this._depthTex),r.uniform1i(o.uniforms.shadowMap,4));for(var l=0;l<t.length;l++)r.uniformMatrix4fv(o.uniforms.model,!1,t[l].world),r.drawElements(r.TRIANGLES,s.indices.count,r.UNSIGNED_SHORT,0);r.disableVertexAttribArray(o.attributes.POSITION),o.attributes.NORMAL>-1&&r.disableVertexAttribArray(o.attributes.NORMAL),o.attributes.TEXCOORD_0>-1&&r.disableVertexAttribArray(o.attributes.TEXCOORD_0)}}},u.prototype._rShader=function(t,e,i){(r=this.root.gl).useProgram(i.program);var r=this.root.gl;if(t[0].primitives&&t[0].primitives.length)for(var n=0;n<t[0].primitives.length;n++){var s=t[0].primitives[n];r.enableVertexAttribArray(i.attributes.POSITION),r.bindBuffer(r.ARRAY_BUFFER,s.attributes.POSITION.bufferView.buffer),r.vertexAttribPointer(i.attributes.POSITION,3,r.FLOAT,!1,s.attributes.POSITION.bufferView.stride,s.attributes.POSITION.byteOffset),r.uniformMatrix4fv(i.uniforms.pview,!1,e.pView),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,s.indices.bufferView.buffer);for(var o=0;o<t.length;o++)r.uniformMatrix4fv(i.uniforms.model,!1,t[o].world),r.drawElements(r.TRIANGLES,s.indices.count,r.UNSIGNED_SHORT,0);r.disableVertexAttribArray(i.attributes.POSITION)}},u.prototype.initImages=function(){var t=this.root.gl,e=new Float32Array([-1,1,-1,-1,1,-1,-1,1,1,-1,1,1]);this._imgTriBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this._imgTriBuffer),t.bufferData(t.ARRAY_BUFFER,e,t.STATIC_DRAW);var i={vertex:"\nprecision mediump int;\nprecision mediump float;\n\nattribute vec2 aPosition;\nvarying vec2 vTexCoords;\n\nvoid main() {\n  vTexCoords = aPosition*0.5 + 0.5;\n  gl_Position = vec4(aPosition, 0.0, 1.0);\n}\n",fragment:"\nprecision mediump int;\nprecision mediump float;\n\nuniform sampler2D displayTex;\nuniform float alpha;\nvarying vec2 vTexCoords;\n\nvoid main() {\n  vec4 t = texture2D(displayTex, vTexCoords);\n  t.a *= alpha;\n  gl_FragColor = t;\n}\n"};this._imgShader=new r.a(this.root,"IMG",null,i)},u.prototype.initShadows=function(t){var e=this.root.gl,i=e.createTexture(),n=this._shadowSize;e.bindTexture(e.TEXTURE_2D,i),e.texImage2D(e.TEXTURE_2D,0,e.DEPTH_COMPONENT24,n,n,0,e.DEPTH_COMPONENT,e.UNSIGNED_INT,null),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE);var s=e.createTexture();e.bindTexture(e.TEXTURE_2D,s),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,n,n,0,e.RGBA,e.UNSIGNED_BYTE,null),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE);var o=e.createFramebuffer();if(e.bindFramebuffer(e.FRAMEBUFFER,o),e.framebufferTexture2D(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.TEXTURE_2D,i,0),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,s,0),status=e.checkFramebufferStatus(e.FRAMEBUFFER),36053!=status?console.log("The created frame buffer is invalid: "+status.toString()):console.log("Initialized Shadow Frame Buffer"),this._depthFrame=o,this._depthTex=i,i,null===this._lightShader){var a={vertex:"\nprecision highp float;\nattribute vec4 aPosition;\nuniform mat4 mPV;\nuniform mat4 mM;\nvoid main(void) {\n    gl_Position = mPV * mM * aPosition;\n}\n",fragment:"\nprecision highp float;\n\nvoid main() {\n  gl_FragColor = vec4(gl_FragCoord.z, gl_FragCoord.z, gl_FragCoord.z, 1.0);\n}\n"};this._lightShader=new r.a(this.root,"LT",null,a)}this._shadowLight=t},u.prototype.shadow=function(){return new Promise(function(t,e){var i=this.root.gl;if(this._shadowLight){if(this.root._shadowArea){this.root._shadowArea.worldPos.copy(this.root._shadowArea.center),this.root._shadowArea.worldRadius=this.root._shadowArea.radius;var r=this.root._shadowArea.center}else r=new n.a;if(i.bindFramebuffer(i.FRAMEBUFFER,this._depthFrame),i.viewport(0,0,this._shadowSize,this._shadowSize),i.clearColor(1,1,1,1),i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT),this.root._shadowArea.worldRadius>0){var o=s.a.create();s.a.lookAt(o,this._shadowLight.worldPos,r,h);var u=this._shadowLight.worldPos.clone().subVector(r).length(),l=1*this.root._shadowArea.radius,c=Math.atan(2*l/u);for(var f in s.a.perspective(this._shadowCam.projection,c,1,u-l,u+l),s.a.invert(a,o),s.a.multiply(this._shadowCam.pView,this._shadowCam.projection,a),this._casters)this._rShader(this._casters[f],this._shadowCam,this._lightShader);i.bindFramebuffer(i.FRAMEBUFFER,null),t()}else i.bindFramebuffer(i.FRAMEBUFFER,null),t()}else t()}.bind(this))},u.prototype.walkTree=function(t,e){return new Promise(function(i,r){var n=this.root.gl;if(t.primitives&&t.primitives.length){e&&t.area&&this.area(t.area,e);for(var s=0;s<t.primitives.length;s++)if(e)this.primitive(t.primitives[s],t.world,e);else if(t.castShadows){var o=t.primitives[s],a=this._lightShader;a&&(n.useProgram(a.program),n.enableVertexAttribArray(a.attributes.POSITION),n.bindBuffer(n.ARRAY_BUFFER,o.attributes.POSITION.bufferView.buffer),n.vertexAttrilightPointer(a.attributes.POSITION,3,n.FLOAT,!1,o.attributes.POSITION.bufferView.stride,o.attributes.POSITION.byteOffset),n.uniformMatrix4fv(a.uniforms.model,!1,t.world),n.uniformMatrix4fv(a.uniforms.pview,!1,this._shadowView),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,o.indices.bufferView.buffer),n.drawElements(n.TRIANGLES,o.indices.count,n.UNSIGNED_SHORT,0),n.disableVertexAttribArray(a.attributes.POSITION))}}for(var h=[],u=0;u<t.childs.length;u++){var l=this.root.get(t.childs[u]);l.enabled&&h.push(this.walkTree(l,e))}Promise.all(h).then(function(){i()}.bind(this))}.bind(this))},u.prototype.primitive=function(t,e,i){var r=this.root.gl;r.bindFramebuffer(r.FRAMEBUFFER,null);var n=this.root._index.getMat([t.material]).preDraw(this.root,this.debug);if(n){for(var s=this.root._index.getLights(),o=0;o<s.length;o++){var a=this.root.get(s[o]);r.uniform3f(n.uniforms["lights"+o+"position"],a.position.x,a.position.y,a.position.z),r.uniform3f(n.uniforms["lights"+o+"color"],a.color.x,a.color.y,a.color.z),r.uniform1f(n.uniforms["lights"+o+"ambient"],a.ambient)}r.enableVertexAttribArray(n.attributes.POSITION),this.debug&&console.log("P:"+r.isBuffer(t.attributes.POSITION.bufferView.buffer)+" - "+t.attributes.POSITION.count),r.bindBuffer(r.ARRAY_BUFFER,t.attributes.POSITION.bufferView.buffer),r.vertexAttribPointer(n.attributes.POSITION,3,r.FLOAT,!1,t.attributes.POSITION.bufferView.stride,t.attributes.POSITION.byteOffset),t.attributes.NORMAL&&n.attributes.NORMAL>-1&&(r.enableVertexAttribArray(n.attributes.NORMAL),r.bindBuffer(r.ARRAY_BUFFER,t.attributes.NORMAL.bufferView.buffer),r.vertexAttribPointer(n.attributes.NORMAL,3,r.FLOAT,!1,t.attributes.NORMAL.bufferView.stride,t.attributes.NORMAL.byteOffset)),t.attributes.TEXCOORD_0&&n.attributes.TEXCOORD_0>-1&&(r.enableVertexAttribArray(n.attributes.TEXCOORD_0),r.bindBuffer(r.ARRAY_BUFFER,t.attributes.TEXCOORD_0.bufferView.buffer),r.vertexAttribPointer(n.attributes.TEXCOORD_0,2,r.FLOAT,!1,t.attributes.TEXCOORD_0.bufferView.stride,t.attributes.TEXCOORD_0.byteOffset)),this.debug&&console.log("I:"+r.isBuffer(t.indices.bufferView.buffer)+" - "+t.indices.count),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,t.indices.bufferView.buffer),r.uniformMatrix4fv(n.uniforms.model,!1,e),r.uniformMatrix4fv(n.uniforms.pview,!1,i.pView),null!=n.uniforms.cam&&r.uniform3f(n.uniforms.cam,i.worldPos.x,i.worldPos.y,i.worldPos.z),null!=n.uniforms.shadow&&r.uniformMatrix4fv(n.uniforms.shadow,!1,this._shadowView),null!=n.uniforms.shadowMap&&(r.activeTexture(r.TEXTURE4),r.bindTexture(r.TEXTURE_2D,this._depthTex),r.uniform1i(n.uniforms.shadowMap,4)),r.drawElements(r.TRIANGLES,t.indices.count,r.UNSIGNED_SHORT,0),r.disableVertexAttribArray(n.attributes.POSITION),n.attributes.NORMAL>-1&&r.disableVertexAttribArray(n.attributes.NORMAL),n.attributes.TEXCOORD_0>-1&&r.disableVertexAttribArray(n.attributes.TEXCOORD_0)}},u.prototype.image=function(t,e){var i=this.root.gl,r=e||1,n=this._imgShader;i.viewport(20,20,128,128),i.useProgram(n.program),i.enableVertexAttribArray(n.attributes.POSITION),i.bindBuffer(i.ARRAY_BUFFER,this._imgTriBuffer),i.vertexAttribPointer(n.attributes.POSITION,2,i.FLOAT,!1,0,0),i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,t),i.uniform1i(n.uniforms.displayTex,0),i.uniform1f(n.uniforms.alpha,r),i.drawArrays(i.TRIANGLES,0,6),i.disableVertexAttribArray(n.attributes.POSITION)},u.prototype.initSprites=function(){var t=this.root.gl,e=new Float32Array([-1,1,0,1,1,0,1,-1,0,-1,1,0,1,-1,0,-1,-1,0]);this._spriteBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this._spriteBuffer),t.bufferData(t.ARRAY_BUFFER,e,t.STATIC_DRAW);var i={vertex:"\nprecision mediump int;\nprecision mediump float;\n\nattribute vec4 aPosition;\nvarying vec2 vTexCoords;\n\nuniform mat4 mPV;\nuniform mat4 mM;\n\nvoid main() {\n  vTexCoords = aPosition.xy *0.5 + 0.5;\n  gl_Position = vec4(mPV * mM * aPosition);\n}\n",fragment:"\nprecision mediump int;\nprecision mediump float;\n\nuniform sampler2D displayTex;\nuniform vec4 color;\nvarying vec2 vTexCoords;\n\nvoid main() {\n  vec4 t = texture2D(displayTex, vTexCoords) * color;\n  gl_FragColor = t;\n}\n"};this._spriteShader=new r.a(this.root,"SPR",null,i)},u.prototype.sprite=function(t,e,i,r){var n=this.root.gl,s=r||[1,1,1,1],o=this._spriteShader;n.depthMask(!1),n.useProgram(o.program),n.enableVertexAttribArray(o.attributes.POSITION),n.bindBuffer(n.ARRAY_BUFFER,this._spriteBuffer),n.vertexAttribPointer(o.attributes.POSITION,3,n.FLOAT,!1,0,0),n.activeTexture(n.TEXTURE0),n.bindTexture(n.TEXTURE_2D,t),n.uniform1i(o.uniforms.displayTex,0),n.uniform4fv(o.uniforms.color,s),n.uniformMatrix4fv(o.uniforms.model,!1,e),n.uniformMatrix4fv(o.uniforms.pview,!1,i.pView),n.drawArrays(n.TRIANGLES,0,6),n.disableVertexAttribArray(o.attributes.POSITION),n.depthMask(!0)},u.prototype.initAreas=function(){this._areaImg=new o.a(this.root,"Circle",null,"./MGL/assets/circle.png",[127,127,255]).texture},u.prototype.area=function(t,e,i){var r=i||[.5,.5,1,.5],n=s.a.create();s.a.lookAt(n,t.worldPos,e.worldPos,h,t.worldRadius),this.sprite(this._areaImg,n,e,r)}},function(t,e,i){"use strict";i.d(e,"a",(function(){return a}));var r=i(3),n=i(0),s=i(1),o=s.a.create();new n.a,new n.a;function a(t,e,i,n,o,a,u,l){if(this._stereo=!1,this._fov=50,this._near=.1,this._far=100,this._aspect=1,this.projection=null,this._pmCalc=null,l){var c=t.get(l);if(c){this._stereo=c;var f=c.quaternion.clone().rotateY(Math.PI/2-.1).Forward().multiplyScalar(-.2).add(c.position),d=c.quaternion.clone().rotateY(-.1);r.a.call(this,t,c.parent,i,f,d,c.scale,u),this.projection=c.projection,this.qOffsets=c.qOffsets,this.lookAt=c.lookAt}else console.log("Unfound: "+l)}else r.a.call(this,t,e,i,n,o,a,u),this.projection=s.a.create(),this._pmCalc=!0;this._mCalc=!0,this.pView=s.a.create(),this._frustum=new h}function h(){this.planes=[];for(var t=0;t<6;t++)this.planes.push(new u(0,0,0,0))}function u(t,e,i,r){this._m=s.a.create(),this.normal=new n.a(t,e,i),this.d=r}a.prototype=Object.create(r.a.prototype),a.prototype.constructor=a,Object.assign(a.prototype,{fov:function(t){this._fov=t,this._pmCalc=!0},afterMatrix:function(t,e){e&&(this._mCalc=!0)},render:function(t){return this._stereo||t==this._aspect||(this._pmCalc=!0,this._aspect=t),this._pmCalc&&s.a.perspective(this.projection,this._fov*Math.PI/180,this._aspect,this._near,this._far),(this._mCalc||this._pmCalc)&&(s.a.invert(o,this.world),s.a.multiply(this.pView,this.projection,o),this._frustum.update(this.pView)),this._mCalc=!1,this._pmCalc=!1,this.root.renderer.camera(this)}}),h.prototype.update=function(t){this.planes[0].normal.x=t[3]+t[2],this.planes[0].normal.y=t[7]+t[6],this.planes[0].normal.z=t[11]+t[10],this.planes[0].d=t[15]+t[14],this.planes[0].normalize(),this.planes[1].normal.x=t[3]-t[2],this.planes[1].normal.y=t[7]-t[6],this.planes[1].normal.z=t[11]-t[10],this.planes[1].d=t[15]-t[14],this.planes[1].normalize(),this.planes[2].normal.x=t[3]+t[0],this.planes[2].normal.y=t[7]+t[4],this.planes[2].normal.z=t[11]+t[8],this.planes[2].d=t[15]+t[12],this.planes[2].normalize(),this.planes[3].normal.x=t[3]-t[0],this.planes[3].normal.y=t[7]-t[4],this.planes[3].normal.z=t[11]-t[8],this.planes[3].d=t[15]-t[12],this.planes[3].normalize(),this.planes[4].normal.x=t[3]-t[1],this.planes[4].normal.y=t[7]-t[5],this.planes[4].normal.z=t[11]-t[9],this.planes[4].d=t[15]-t[13],this.planes[4].normalize(),this.planes[5].normal.x=t[3]+t[1],this.planes[5].normal.y=t[7]+t[5],this.planes[5].normal.z=t[11]+t[9],this.planes[5].d=t[15]+t[13],this.planes[5].normalize()},h.prototype.sphereIn=function(t,e){for(let i=0;i<6;i++)if(this.planes[i].dot(t)<=-e)return!1;return!0},u.prototype.normalize=function(){var t=this.normal.length(),e=0;return 0!==t&&(e=1/t),this.normal.multiplyScalar(e),this.d*=e,this},u.prototype.dot=function(t){return this.normal.x*t.x+this.normal.y*t.y+this.normal.z*t.z+this.d}},function(t,e,i){"use strict";i.d(e,"a",(function(){return s}));var r=i(0),n=i(4);function s(t,e,i,n,s,o,a,h,u){this.name=t||"",this.base=e||new r.a(1,1,1),this.roughness=i,void 0===i&&(this.roughness=.3),this.metallic=n||0,this.emissive=s||new r.a,this.baseTexture=o||null,this.normTexture=a||null,this.romeTexture=h||null,this.emisTexture=null,this.shader=u||null}s.prototype.setShader=function(t,e){var i=e||"dF",r=[];e||this.baseTexture&&(r.push("_UV"),null===this.normTexture&&(this.normTexture=new n.a(t,"",null,null,[127,127,255])),null===this.romeTexture&&(this.romeTexture=new n.a(t,"",null,null,[0,127,0])),null===this.emisTexture&&(this.emisTexture=new n.a(t,"",null,null,[0,0,0]))),this.shader=t.AddShader(i,r)},s.prototype.preDraw=function(t,e){var i=t.gl;if(this.shader){var r=t._index.getShade([this.shader]);return i.useProgram(r.program),i.uniform3f(r.uniforms.matBase,this.base.x,this.base.y,this.base.z),i.uniform3f(r.uniforms.matEmiss,this.emissive.x,this.emissive.y,this.emissive.z),i.uniform1f(r.uniforms.matRough,this.roughness),i.uniform1f(r.uniforms.matMetal,this.metallic),this.baseTexture&&r.uniforms.matBaseTex&&(i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,this.baseTexture.texture),i.uniform1i(r.uniforms.matBaseTex,0),i.activeTexture(i.TEXTURE1),i.bindTexture(i.TEXTURE_2D,this.romeTexture.texture),i.uniform1i(r.uniforms.matRomeTex,1),i.activeTexture(i.TEXTURE2),i.bindTexture(i.TEXTURE_2D,this.normTexture.texture),i.uniform1i(r.uniforms.matNormTex,2),r.uniforms.matEmisTex&&(i.activeTexture(i.TEXTURE3),i.bindTexture(i.TEXTURE_2D,this.emisTexture.texture),i.uniform1i(r.uniforms.matEmisTex,3))),r.uniforms.envTex&&(t.gl.activeTexture(i.TEXTURE6),t.gl.bindTexture(i.TEXTURE_CUBE_MAP,t.environments[0].texture),t.gl.uniform1i(r.uniforms.envTex,6)),r}return null}},function(t,e,i){"use strict";i.d(e,"a",(function(){return a}));var r=i(5),n=i(1),s=i(0),o=i(2);function a(t,e,i,r){this.root=t,this.name=e||"",this.texture=null,this.imgs=i||[],this._waits=0,this.urls=r||["MGL/assets/env/default/px.png","MGL/assets/env/default/nx.png","MGL/assets/env/default/py.png","MGL/assets/env/default/ny.png","MGL/assets/env/default/pz.png","MGL/assets/env/default/nz.png"],this.skybox=new Float32Array([-1,1,-1,-1,-1,-1,1,-1,-1,1,-1,-1,1,1,-1,-1,1,-1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,-1,-1,1,1,-1,-1,1,1,-1,-1,1,-1,1,1,1,1,1,1,1,1,1,-1,1,-1,-1,-1,-1,1,-1,1,1,1,1,1,1,1,1,1,-1,1,-1,-1,1,-1,1,-1,1,1,-1,1,1,1,1,1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,1,-1,-1,1,-1,-1,-1,-1,1,1,-1,1]),this.position=new s.a,this.quaternion=new o.a,this.scale=new s.a(1,1,1),this.matrix=n.a.create(),this.buffer=null,this.shader=null,this._blur=1e-4,this.init()}function h(t){return 0==(t&t-1)}a.prototype.init=function(){var t=this.root,e=t.gl;if(n.a.compose(this.matrix,this.position,this.quaternion,this.scale),this.buffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.buffer),e.bufferData(e.ARRAY_BUFFER,this.skybox,e.STATIC_DRAW),this.texture=e.createTexture(),e.bindTexture(e.TEXTURE_CUBE_MAP,this.texture),e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_MIN_FILTER,e.LINEAR_MIPMAP_NEAREST),e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_MAG_FILTER,e.LINEAR),0===this.imgs.length){var i=new Uint8Array([224,240,255,255,224,240,255,255,192,208,160,255,194,208,160,255]);e.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+0,0,e.RGBA,2,2,0,e.RGBA,e.UNSIGNED_BYTE,i),e.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+1,0,e.RGBA,2,2,0,e.RGBA,e.UNSIGNED_BYTE,i),e.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+4,0,e.RGBA,2,2,0,e.RGBA,e.UNSIGNED_BYTE,i),e.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+5,0,e.RGBA,2,2,0,e.RGBA,e.UNSIGNED_BYTE,i);var s=new Uint8Array([240,240,255,255,255,255,255,255,240,240,255,255,240,255,255,255]);e.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+2,0,e.RGBA,2,2,0,e.RGBA,e.UNSIGNED_BYTE,s);var o=new Uint8Array([224,240,208,255,224,240,208,255,224,240,208,255,224,240,208,255]);e.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+3,0,e.RGBA,2,2,0,e.RGBA,e.UNSIGNED_BYTE,o),e.generateMipmap(e.TEXTURE_CUBE_MAP)}else{for(var a=0;a<6;a++)e.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+a,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,this.imgs[a]);e.generateMipmap(e.TEXTURE_CUBE_MAP)}if(this.urls&&this.urls.length){this._waits=6;for(a=0;a<6;a++)this.imgs[a]=new Image,this.imgs[a].onload=function(t,e){return function(){t._waits-=1,t._waits<1&&t.loadCube()}}(this),this.imgs[a].src=this.urls[a]}this.shader=new r.a(t,"env",[],{vertex:"\n        attribute vec3 aPosition;\n        uniform mat4 mPV;\n        uniform mat4 mM;\n        varying vec3 vPosition;\n        void main() {\n            vec4 WVP_Pos = mPV * mM * vec4(aPosition, 1.0);\n            vPosition = aPosition;\n            gl_Position = WVP_Pos.xyww;\n        }\n    ",fragment:"\n        precision mediump float;\n        uniform samplerCube envTexture;\n        uniform float blur;\n        varying vec3 vPosition;\n        void main() {\n            vec4 c = textureCube(envTexture, vPosition);\n            if (blur > 0.001) {\n                c += textureCube(envTexture, vPosition + vec3(blur, blur, blur));\n                c += textureCube(envTexture, vPosition + vec3(-blur, blur, blur));\n                c += textureCube(envTexture, vPosition + vec3(blur, -blur, blur));\n                c += textureCube(envTexture, vPosition + vec3(-blur, -blur, blur));\n                c += textureCube(envTexture, vPosition + vec3(blur, blur, -blur));\n                c += textureCube(envTexture, vPosition + vec3(-blur, blur,-blur));\n                c += textureCube(envTexture, vPosition + vec3(blur, -blur,-blur));\n                c += textureCube(envTexture, vPosition + vec3(-blur, -blur, -blur));\n                c = c/9.0;\n            }\n            gl_FragColor = c;\n        }\n    "})},a.prototype.loadCube=function(){var t=this.root.gl;t.bindTexture(t.TEXTURE_CUBE_MAP,this.texture),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_MIN_FILTER,t.LINEAR_MIPMAP_NEAREST),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_COMPARE_MODE,t.NONE),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_COMPARE_FUNC,t.LEQUAL);for(var e=0;e<6;e++)t.texImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+e,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,this.imgs[e]);var i=this.imgs[0].width;this._blur=2/i*.4,h(i)&&h(this.imgs[0].height)&&t.generateMipmap(t.TEXTURE_CUBE_MAP),console.log("LOADED ENV MAPS"),t.bindTexture(t.TEXTURE_CUBE_MAP,null)},a.prototype.render=function(t){var e=this.root.gl;e.useProgram(this.shader.program),this.shader.uniforms.envTex&&(e.activeTexture(e.TEXTURE6),e.bindTexture(e.TEXTURE_CUBE_MAP,this.texture),e.uniform1i(this.shader.uniforms.envTex,6),e.uniform1f(this.shader.uniforms.blur,this._blur)),e.enableVertexAttribArray(this.shader.attributes.POSITION),e.bindBuffer(e.ARRAY_BUFFER,this.buffer),e.vertexAttribPointer(this.shader.attributes.POSITION,3,e.FLOAT,!1,0,0),n.a.copyPos(this.matrix,t.world),e.uniformMatrix4fv(this.shader.uniforms.model,!1,this.matrix),e.uniformMatrix4fv(this.shader.uniforms.pview,!1,t.pView),e.depthFunc(e.LEQUAL),e.drawArrays(e.TRIANGLES,0,36)}},function(t,e,i){"use strict";i.d(e,"a",(function(){return s}));var r=i(0),n=i(3);i(1);function s(t,e,i,s,o,a,h,u){var l=s||new r.a(1e3,3e3,2e3);n.a.call(this,t,e,i,l,o),this.color=a||new r.a(1,1,1),this.ambient=h||.2,this.shadows=u||!1,this.shadows&&t.renderer.initShadows(this)}s.prototype=Object.create(n.a.prototype),s.prototype.constructor=s,Object.assign(s.prototype,{})},function(t,e,i){"use strict";i.d(e,"a",(function(){return n}));var r=i(0),n={MakeCube:function(t,e){for(var i=new Float32Array(72),r=new Float32Array(72),n=new Uint16Array(36),s=[[0,0,1],[0,0,-1],[1,0,0],[-1,0,0],[0,1,0],[0,-1,0]],o=[-1,1,1,-1,-1,1,1,1,1,1,-1,1,1,1,-1,1,-1,-1,-1,1,-1,-1,-1,-1,1,1,1,1,-1,1,1,1,-1,1,-1,-1,-1,1,-1,-1,-1,-1,-1,1,1,-1,-1,1,1,1,-1,-1,1,-1,1,1,1,-1,1,1,1,-1,1,-1,-1,1,1,-1,-1,-1,-1,-1],a=0;a<6;a++){for(var h=0;h<4;h++){var u=12*a+3*h;r[u]=s[a][0],r[u+1]=s[a][1],r[u+2]=s[a][2],i[u]=o[u],i[u+1]=o[u+1],i[u+2]=o[u+2]}n[6*a+0]=4*a,n[6*a+1]=4*a+1,n[6*a+2]=4*a+2,n[6*a+3]=4*a+2,n[6*a+4]=4*a+1,n[6*a+5]=4*a+3}return t._maker={type:"Forge",func:"MakeCube",params:[e]},t.addData(e,i,n,r)},MakeIsoSphere:function(t,e,i,n){const a=.8506507873535156,h=.525731086730957;for(var u=[new r.a(h,a,0),new r.a(-h,a,0),new r.a(h,-a,0),new r.a(-h,-a,0),new r.a(0,h,a),new r.a(0,-h,a),new r.a(0,h,-a),new r.a(0,-h,-a),new r.a(a,0,h),new r.a(-a,0,h),new r.a(a,0,-h),new r.a(-a,0,-h)],l=[[0,1,4],[1,9,4],[4,9,5],[5,9,3],[2,3,7],[3,2,5],[7,10,2],[0,8,10],[0,4,8],[8,2,10],[8,4,5],[8,5,2],[1,0,6],[11,1,6],[3,9,11],[6,10,7],[3,11,7],[11,6,7],[6,0,10],[9,1,11]],c=0;c<n;c++)o(u,l);var f=[];for(c=0;c<u.length;c++)f.push(u[c].clone()),u[c].multiplyScalar(i);return t._maker={type:"Forge",func:"MakeIsoSphere",params:[e,i,n]},t.addData(e,s(u),function(t){for(var e=t.length,i=new Uint16Array(3*e),r=0;r<e;r++){var n=3*r;i[n]=t[r][0],i[n+1]=t[r][1],i[n+2]=t[r][2]}return i}(l),s(f))}};function s(t){for(var e=t.length,i=0,r=new Float32Array(3*e),n=0;n<e;n++)t[n].toArray(r,i),i+=3;return r}function o(t,e){for(var i=t.length,r=new Array(i),n=0;n<i;n++)r[n]=new Array(i);const s=[];var o=e.length;for(n=0;n<o;n++){var a,h,u,l=e[n][0],c=e[n][1],f=e[n][2];r[l][c]?a=r[l][c]:(t.push(t[l].clone().nlerp(t[c],.5)),a=i,r[l][c]=a,r[c][l]=a,i++),r[c][f]?h=r[c][f]:(t.push(t[c].clone().nlerp(t[f],.5)),h=i,r[c][f]=h,r[f][c]=h,i++),r[f][l]?u=r[f][l]:(t.push(t[f].clone().nlerp(t[l],.5)),u=i,r[f][l]=u,r[l][f]=u,i++),s.push([l,a,u]),s.push([c,h,a]),s.push([f,u,h]),s.push([a,h,u])}e.length=0,e.push.apply(e,s)}},function(t,e,i){"use strict";i.d(e,"a",(function(){return u}));i(10);var r=i(0),n=i(2),s=i(8),o=i(6),a=i(7),h=i(4);function u(t,e,i,r,n,s){return function(t,e,i,r,n,s){var o=[],a=[];if(!t)return null;var h=e.AddMesh(i,r,n,null,null,!0,s),u="",f=t.lastIndexOf("/");-1!==f&&(u=t.substring(0,f+1));fetch(t,{method:"get",headers:{Accept:"text/plain, */*","Content-Type":"application/json"}}).then((function(t){return t.json()})).then((function(t){if(!t.buffers)return c(o,a,t,e,h,i,n,s);var r=[];for(var f in t.buffers)r.push(l(o,u+t.buffers[f].uri,f));for(var d in t.images)a[d]=u+t.images[d].uri;Promise.all(r).then((function(){return c(o,a,t,e,h,i,n,s)}))}))}(t,e,i,r,n,s)}function l(t,e,i){return fetch(e,{}).then((function(t){return t.arrayBuffer()})).then((function(e){t[i]=e}))}function c(t,e,i,u,l,c,f,d){var m=u,_=!0,p=[],v=[],g=[];if(i.bufferViews)for(var b=0,x=i.bufferViews.length;b<x;b++)p[b]=new a.a(i.bufferViews[b].byteOffset,i.bufferViews[b].byteLength,t[i.bufferViews[b].buffer]);if(i.accessors)for(b=0,x=i.accessors.length;b<x;b++)v[b]=new o.a(i.accessors[b],p[i.accessors[b].bufferView]);for(b=0,x=i.materials.length;b<x;b++){var T=i.materials[b].name;if(g.push(T),void 0===m._index.getMat(T)){var E=m.AddMaterial(T);if(i.materials[b].pbrMetallicRoughness){if(i.materials[b].pbrMetallicRoughness.baseColorFactor){var w=i.materials[b].pbrMetallicRoughness.baseColorFactor;E.base=new r.a(w[0],w[1],w[2])}var y;if(i.materials[b].pbrMetallicRoughness.baseColorTexture)void 0!==(y=i.materials[b].pbrMetallicRoughness.baseColorTexture).index&&(E.baseTexture=new h.a(u,"tex",null,e[y.index]));if(i.materials[b].normalTexture)void 0!==(y=i.materials[b].normalTexture).index&&(E.normTexture=new h.a(u,"ntex",null,e[y.index]));if(i.materials[b].pbrMetallicRoughness.metallicRoughnessTexture)void 0!==(y=i.materials[b].pbrMetallicRoughness.metallicRoughnessTexture).index&&(E.romeTexture=new h.a(u,"rtex",null,e[y.index]),E.metallic=1,E.roughness=1);i.materials[b].pbrMetallicRoughness.metallicFactor&&(E.metallic=i.materials[b].pbrMetallicRoughness.metallicFactor),void 0!==i.materials[b].pbrMetallicRoughness.roughnessFactor&&(E.roughness=i.materials[b].pbrMetallicRoughness.roughnessFactor)}if(i.materials[b].emissiveTexture)void 0!==(y=i.materials[b].emissiveTexture).index&&(E.emisTexture=new h.a(u,"etex",null,e[y.index]));if(void 0!==i.materials[b].emissiveFactor){w=i.materials[b].emissiveFactor;E.emissive=new r.a(w[0],w[1],w[2])}E.setShader(m)}}var A=[],M=[],R=new Array(i.nodes.length);for(b=0,x=i.nodes.length;b<x;b++){var P=null,O=null,U=null,L=d;void 0!==i.nodes[b].translation&&(P=(new r.a).fromArray(i.nodes[b].translation)),void 0!==i.nodes[b].rotation&&(O=(new n.a).fromArray(i.nodes[b].rotation)),void 0!==i.nodes[b].scale&&(U=(new r.a).fromArray(i.nodes[b].scale));var I=i.nodes[b].name||null;f&&(P?P.addVector(f):P=f);var S=null;if(void 0!==i.nodes[b].mesh){var D=i.meshes[i.nodes[b].mesh];_?(S=l,P&&S.position.copy(P),O&&(S.quaternion=O),U&&(S.scale=U),S.changed=!0,_=!1):S=m.AddMesh(c,I,P,O,U,!0,L),console.log("M:"+S.name+" @:"+S.position);for(var C=0,z=D.primitives.length;C<z;C++){var B=new s.b(u);for(var F in D.primitives[C].attributes)B.attributes[F]=v[D.primitives[C].attributes[F]],"POSITION"===F&&(B.bounds.min=v[D.primitives[C].attributes[F]].min,B.bounds.max=v[D.primitives[C].attributes[F]].max);B.indices=v[D.primitives[C].indices],B.material=g[D.primitives[C].material],S.primitives.push(B)}S.prepare(),M[i.nodes[b].mesh]=S,void 0!==i.nodes[b].skin&&(A[i.nodes[b].skin]=S)}else S=void 0!==i.nodes[b].camera?m.AddCamera(c,I,P,O):m.AddTransform(c,I,P,O,U);R[b]=S}for(b=0,x=i.nodes.length;b<x;b++)if(void 0!==i.nodes[b].children)for(var N=0,V=i.nodes[b].children.length;N<V;N++){var X=i.nodes[b].children[N];R[X].parent=R[b].name,R[X].changed=!0}}},function(t,e,i){"use strict";i.d(e,"a",(function(){return m}));var r=i(0),n=i(2),s=Math.PI/180,o=(new r.a,new r.a(1,0,0)),a=(new r.a(0,1,0),new r.a(0,0,1)),h=(new n.a,new n.a),u=new n.a;(new n.a).setAxisAngle(o,-Math.PI/2);var l=new n.a(-Math.sqrt(.5),0,0,Math.sqrt(.5));(new n.a).fromDevice(0,90*s,0),(new n.a).fromDevice(0,90*s,-90*s);function c(t){this.root=t,this.element=t.canvas,this.points={},this.ended=[],this.keys={},this.gestures=[],this.sensor=null,this.quaternion=new n.a,this._alphaOffset=0,this._lGamma=0,this._lAlpha=0,this._lBeta=0,this._moves=!1,this.hasOrientationAPI=!(!window.screen||!window.screen.orientation||void 0===window.screen.orientation.angle||null===window.screen.orientation.angle),this.orientation=this.hasOrientationAPI?window.screen.orientation.angle:window.orientation||0,window.PointerEvent?(this.element.addEventListener("pointerdown",this,!0),this.element.addEventListener("pointermove",this,!0),this.element.addEventListener("pointerup",this,!0),this.element.addEventListener("pointercancel",this,!0)):(this.element.addEventListener("touchstart",this,!0),this.element.addEventListener("touchmove",this,!0),this.element.addEventListener("touchend",this,!0),this.element.addEventListener("touchcancel",this,!0),this.element.addEventListener("mousedown",this,!0)),window.addEventListener("keydown",this,!1),window.addEventListener("keyup",this,!1);try{this.sensor=new RelativeOrientationSensor({frequency:60,referenceFrame:"device"}),Promise.all([navigator.permissions.query({name:"accelerometer"}),navigator.permissions.query({name:"gyroscope"})]).then(function(t){t.every(t=>"granted"===t.state)?this.sensor&&(this.sensor.addEventListener("reading",this),this.sensor.start()):console.log("No orientation permissions.")}.bind(this))}catch(t){console.log("SENSOR:"+t.name+":"+t.message),this.sensor=null}window.addEventListener("deviceorientation",this,!1),window.addEventListener("orientationchange",this,!1)}c.prototype.update=function(){for(var t in this.gestures.length=0,this.points){var e=(r=this.points[t]).x-r.sx,i=r.y-r.sy;if(e*e+i*i>100)this.gestures.push({type:"drag",sx:r.sx,sy:r.sy,dx:e,dy:i});else(n=Date.now()-r.st)>500&&this.gestures.push({type:"hold",sx:r.sx,sy:r.sy,t:n})}for(;this.ended.length;){var r,n;(n=(r=this.ended.pop()).t-r.st)<300&&this.gestures.push({type:"tap",sx:r.sx,sy:r.sy})}var o,a,h,l;a=(o=this)._lAlpha?(o._lAlpha+o._alphaOffset)*s:0,h=o._lBeta?o._lBeta*s:0,l=o._lGamma?o._lGamma*s:0,u.fromDevice(a,h,l),o.quaternion.copy(u)};function f(t,e,i,r){if(e.pointerId)d(t,e.pointerId,e.clientX,e.clientY,i,r);else if(e.changedTouches)for(var n=0,s=e.changedTouches.length;n<s;n++){var o=e.changedTouches[n];d(t,o.identifier,o.clientX,o.clientY,i,r)}else d(t,"mouse",e.clientX,e.clientY,i,r)}function d(t,e,i,r,n,s){var o=t.points[e];n&&(t.points[e]={},(o=t.points[e]).sx=i,o.sy=r,o.st=Date.now()),o&&(o.x=i,o.y=r,o.t=Date.now()),s&&(t.ended.push({sx:o.sx,sy:o.sy,st:o.st,x:o.x,y:o.y,t:o.t}),o=null,delete t.points[e],console.log("Ended: "+e))}c.prototype.handleEvent=function(t){switch(t.type){case"pointermove":case"touchmove":case"mousemove":t.preventDefault(),f(this,t);break;case"pointerdown":case"touchdown":t.preventDefault(),f(this,t,!0);break;case"pointerup":case"pointercancel":case"touchup":case"touchcancel":t.preventDefault(),f(this,t,!1,!0);break;case"mousedown":t.preventDefault(),f(this,t,!0),document.addEventListener("mousemove",this,!0),document.addEventListener("mouseup",this,!0);break;case"mouseup":t.preventDefault(),f(this,t,!1,!0),document.removeEventListener("mousemove",this,!0),document.removeEventListener("mouseup",this,!0);break;case"deviceorientation":null!=t.gamma&&Math.abs(t.gamma-this._lGamma)>.05&&(this._lGamma=t.gamma,this._moves=!0),null!=t.beta&&Math.abs(t.beta-this._lBeta)>.05&&(this._lBeta=t.beta,this._moves=!0),null!=t.alpha&&Math.abs(t.alpha-this._lAlpha)>.05&&(this._lAlpha=t.alpha,this._moves=!0);break;case"orientationchange":this.orientation=this.hasOrientationAPI?window.screen.orientation.angle:window.orientation||0;break;case"reading":break;case"keydown":t.preventDefault(),this.keys[t.key]=!0;break;case"keyup":t.preventDefault(),this.keys[t.key]=!1;break;default:console.log("Input:"+t.type+" Not Handled")}};var m={XRotY:function(t,e){this.root=t,null===t._inputs&&(t._inputs=new c(t)),t._ctrls.push(this),this.obj=e,this.power=1,this._vel=0,this.root.get(this.obj).pView&&(this.power=-this.power),this.update=function(){for(var t=this.root._inputs,e=this.root.get(this.obj),i=0,r=0;r<t.gestures.length;r++){var n=t.gestures[r];"drag"===n.type&&(i=1e-4*n.dx*this.power)}this._vel=.9*this._vel+.1*i,Math.abs(this._vel)>1e-4&&e.rotateY(this._vel)}.bind(this)},YTranF:function(t,e){this.root=t,null===t._inputs&&(t._inputs=new c(t)),t._ctrls.push(this),this.obj=e,this._vel=0,this.power=1,this.root.get(this.obj).pView&&(this.power=-this.power),this.update=function(){for(var t=this.root._inputs,e=this.root.get(this.obj),i=0,r=0;r<t.gestures.length;r++){var n=t.gestures[r];"drag"===n.type&&(i=-.001*n.dy*this.power)}if(this._vel=.9*this._vel+.1*i,Math.abs(this._vel)>.001){var s=e.quaternion.Forward().multiplyScalar(this._vel);e.move(s)}}.bind(this)},GToQ:function(t,e){this.root=t,null===t._inputs&&(t._inputs=new c(t)),t._ctrls.push(this),this.obj=e,this.power=1,this._last=0;this.root.get(this.obj);this.update=function(){var t=this.root._inputs,e=this.root.get(this.obj);e.qOffsets.push(t.quaternion),e.changed=!0}.bind(this)},GToVR:function(t,e){this.root=t,null===t._inputs&&(t._inputs=new c(t)),t._ctrls.push(this),this.obj=e,this.power=1,this._last=0;this.root.get(this.obj);this.update=function(){var t=this.root._inputs,e=this.root.get(this.obj);t._moves&&(h.copy(l),0!==t.orientation&&h.multiply((new n.a).setAxisAngle(a,-Math.PI/2)),t.quaternion.multiply(h),e.qOffsets.push(t.quaternion),e.changed=!0)}.bind(this)}}},function(t,e,i){"use strict";function r(t){this.r=t,this.names={},this.instances={},this.mats={},this.shades={},this._CA=[],this._LT=[],this._TMCount=0,this._MHCount=0,this._CACount=0,this._LTCount=0,this._MACount=0,this._SHCount=0,this.tree=""}i.d(e,"a",(function(){return r})),Object.assign(r.prototype,{regIns:function(t,e){this.instances[t]=e},regNew:function(t,e,i){var r=i||t+this["_"+t+"count"]++;return void 0!==this.names[r]&&(r+=t+this["_"+t+"count"]++),e.world?(this.names[r]=e,"CA"===t&&this._CA.push(r),"LT"===t&&this._LT.push(r),r):(console.log("Index reg err:"+r),!1)},regMat:function(t,e){var i=t||"MA"+this._MAcount++;return this.mats[i]=e,i},regShade:function(t,e){return this.shades[t]=e,t},get:function(t){return this.names[t]},getMat:function(t){return this.mats[t]},getShade:function(t){return this.shades[t]},getCams:function(){return this._CA},getLights:function(){return this._LT},treeView:function(){return this.tree="<div id='tree'>",this._treeAdd(this.r.base),this.tree+="</div>",this.tree},_treeAdd:function(t){var e="";if(t.name&&(e=t.name),this.tree+="<button onlick=\"seltree('"+e+"')\">"+e+"</button> ",t.castShadows&&(this.tree+="SH "),t.position&&(this.tree+="P:"+t.position.toString()),t.worldPos&&(this.tree+=" W:"+t.worldPos.toString()),this.tree+="<br/>",t.childs&&t.childs.length>0){this.tree+="<ul>";for(var i=0;i<t.childs.length;i++)this._treeAdd(this.get(t.childs[i]));this.tree+="</ul>"}}})}])}));